<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Software Version - SoftMAN</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üñ•Ô∏è SoftMAN</h1>
            <span style="margin-left: 1rem; color: #666; font-size: 0.9rem;">
                {{ current_user.username }}
                {% if current_user.is_superuser %}<span class="badge badge-admin">Admin</span>{% endif %}
            </span>
        </div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('index') }}">Dashboard</a></li>
            <li><a href="{{ url_for('software_list') }}" class="active">Software</a></li>
            <li><a href="{{ url_for('vendors_list') }}">Vendors</a></li>
            <li><a href="{{ url_for('rooms_list') }}">Rooms</a></li>
            <li><a href="{{ url_for('my_assignments') }}">{% if current_user.is_superuser %}Assignments{% else %}My Assignments{% endif %}{% if pending_assignments_count > 0 %}<span class="notification-badge">{{ pending_assignments_count }}</span>{% endif %}</a></li>
            {% if current_user.is_superuser %}
            <li><a href="{{ url_for('compliance_report') }}">Compliance</a></li>
            <li><a href="{{ url_for('users_list') }}">Users</a></li>
            {% endif %}
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>Add New Software Version</h2>
        </div>

        <div class="form-container">
            <form method="post" enctype="multipart/form-data" class="software-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Vendor *</label>
                        <select name="vendor_id" id="vendor_id" required onchange="loadProducts()">
                            <option value="">Select Vendor...</option>
                            {% for vendor in vendors %}
                            <option value="{{ vendor.id }}">{{ vendor.vendor_name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Don't see your vendor? <a href="{{ url_for('add_vendor') }}">Add a new vendor</a></small>
                    </div>
                    <div class="form-group">
                        <label>Product *</label>
                        <select name="product_id" id="product_id" required disabled>
                            <option value="">Select vendor first...</option>
                        </select>
                        <small class="text-muted">Products will load after selecting a vendor</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Version *</label>
                        <input type="text" name="version" required placeholder="e.g., 2024, 1.5.2, 365">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_latest" value="1" style="width: auto; margin-right: 0.5rem;">
                            Mark as Latest Version
                        </label>
                        <small class="text-muted">Check if this is the current/recommended version</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>License Key</label>
                    <input type="text" name="license_key" placeholder="Enter license key if applicable">
                </div>

                <div class="form-group">
                    <label>Release Notes</label>
                    <textarea name="release_notes" rows="3" placeholder="What's new in this version?"></textarea>
                </div>

                <div class="form-group">
                    <label>Installer File (Upload)</label>
                    <input type="file" name="installer" accept=".exe,.msi,.dmg,.pkg,.deb,.rpm,.zip" id="installer_file" onchange="clearUrlField()">
                    <small class="text-muted">Max 500MB. Supported formats: .exe, .msi, .dmg, .pkg, .deb, .rpm, .zip</small>
                </div>

                <div class="form-group">
                    <label>OR Installer URL (Link)</label>
                    <input type="url" name="installer_url" id="installer_url" placeholder="https://example.com/installer.exe" onchange="clearFileField()">
                    <small class="text-muted">Provide a direct link to the installer if not uploading a file</small>
                </div>

                <script>
                    async function loadProducts() {
                        const vendorId = document.getElementById('vendor_id').value;
                        const productSelect = document.getElementById('product_id');
                        
                        if (!vendorId) {
                            productSelect.disabled = true;
                            productSelect.innerHTML = '<option value="">Select vendor first...</option>';
                            return;
                        }

                        try {
                            const response = await fetch(`/api/products/${vendorId}`);
                            const products = await response.json();
                            
                            productSelect.innerHTML = '<option value="">Select Product...</option>';
                            products.forEach(product => {
                                const option = document.createElement('option');
                                option.value = product.id;
                                option.textContent = product.product_name;
                                productSelect.appendChild(option);
                            });
                            productSelect.disabled = false;
                        } catch (error) {
                            console.error('Error loading products:', error);
                            alert('Failed to load products. Please try again.');
                        }
                    }

                    function clearUrlField() {
                        if (document.getElementById('installer_file').value) {
                            document.getElementById('installer_url').value = '';
                        }
                    }

                    function clearFileField() {
                        if (document.getElementById('installer_url').value) {
                            document.getElementById('installer_file').value = '';
                        }
                    }
                </script>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Software Version</button>
                    <a href="{{ url_for('software_list') }}" class="btn btn-outline">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
